modules-y += ncurses

ncurses_depends := $(musl_dep)

ncurses_version := 6.5
ncurses_dir := ncurses-$(ncurses_version)
ncurses_tar := ncurses-$(ncurses_version).tar.gz
ncurses_url := https://invisible-island.net/archives/ncurses/ncurses-$(ncurses_version).tar.gz
ncurses_hash := 136d91bc269a9a5785e5f9e980bc76ab57428f604ce3e5a5a90cebc767971cc6

ncurses_configure := \
	CFLAGS="-Os" ./configure \
	$(CROSS_TOOLS) \
	--host $(MUSL_ARCH)-elf-linux \
	--without-ada \
	--without-cxx \
	--without-cxx-binding \
	--without-manpages \
	--without-shared

# Build and install ncurses data
ncurses_target := $(MAKE_JOBS) \
	$(CROSS_TOOLS) \
	DESTDIR="$(INSTALL)" \
	install.data

# Register terminfo file for data.cpio: source is in install, destination is etc/terminfo/l/linux in initrd
# Do NOT use ifeq/ifneq here, just append unconditionally so it is always present at parse time.
$(info DEBUG: Registering terminfo file for data.cpio: $(INSTALL)/usr/lib/terminfo/l/linux -> etc/terminfo/l/linux)
data_files += $(INSTALL)/usr/lib/terminfo/l/linux|etc/terminfo/l/linux
$(info modules/ncurses: data_files after registration: $(data_files))

# Register all terminfo files in the l/ directory for data.cpio
# This will ensure at least one file exists and is registered.
define ncurses_register_terminfo_files
$(foreach f,$(wildcard $(INSTALL)/usr/lib/terminfo/l/*),\
  $(eval data_files += $(f)|etc/terminfo/l/$(notdir $(f))) \
  $(info modules/ncurses: data_files += $(f)|etc/terminfo/l/$(notdir $(f))) \
)
endef
$(eval $(call ncurses_register_terminfo_files))

